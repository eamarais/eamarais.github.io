<!doctype html>
<html lang="en">
<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Rocket Launch Emissions</title>

	<link rel="stylesheet" href="style.css" type="text/css" media="screen" />
	<style>
		#page { background: url("./themes/default/images/kubrickbgwide.jpg") repeat-y top; border: none; }
	</style>

	<script src="https://cdn.plot.ly/plotly-3.0.3.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/globe.gl"></script>
	<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-L03HTPL2E2"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', 'G-L03HTPL2E2');
	</script>
	
</head>

<body>

<div id="page">
	
<div id="header">

	<!--Header image-->
	<div id="headerimg">
		<h1>
			<a style="color:black" href="http://maraisresearchgroup.co.uk/">
				<div class="transparent-box">Atmospheric Composition and Air Quality Group</div>
			</a>
		</h1>
		<div class="description"></div>
	</div>

	<!--Navigation bar-->
	<div id="navmenu">
		<iframe src="./nav.html" onload="this.before((this.contentDocument.body||this.contentDocument).children[0]);this.remove()"></iframe>
	</div>

</div>

<hr />

<div id="content" class="widecolumn">

	<div class="post" id="post-3">
		<h2 style="text-transform: none;
				   margin-top: 20px;
				   margin-bottom: 20px;
				   font-size: 3.2em;
				   font-weight: 500;
				   line-height: 1.2em;">
			Emissions from Rocket Launches
		</h2>
		<div class="entry">	
				
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css">
					
	<style>

		.filter-container {
			display: flex;
			justify-content: space-around;
			align-items: center;
			padding: 10px 0px 20px 0px;
			gap: 10px;
		}

		.filter {
			position: relative;
			background: #143d59;
			color: whitesmoke;
			padding: 0.25rem;
			height: 15px;
			cursor: pointer; /* show pointer on hover */
		}

		.filter label {
			font-size: 1.2em;
			user-select: none;
			display: inline-flex;
			align-items: center;
			gap: 6px;
			position: relative;
		}

		.filter label::after {
			content: '';
			display: inline-block;
			width: 0; 
			height: 0; 
			border-left: 5px solid transparent;
			border-right: 5px solid transparent;
			border-top: 5px solid whitesmoke;
			vertical-align: middle;
			transition: transform 0.3s ease;
			margin-left: 6px;
		}

		/* Arrow down (open) */
		.filter.open label::after {
			transform: rotate(180deg);
		}

		/* Remove any arrows from dropdown labels */
		.dropdown label::after {
			display: none !important;
			content: none !important;
		}
		/* Hide dropdown initially */
		.dropdown ul {
			display: none;
			position: absolute;
			left:50%;
			transform: translateX(-50%);
			list-style-type: none;
			background-color: #8dc4ee;
			max-height: 300px;
			overflow-y: auto;
			width: auto;
			min-width: 150px; /* Ensure a minimum width */
			white-space: nowrap;
			border-radius: 5px;
			z-index: 100;
			top: 15px;
		}

		.dropdown label {
			font-size: 1.2em;
			display: flex;
			align-items: center;
			gap: 15px;
			padding: 0;
		}

		.filter.open .dropdown ul {
			display: block;
			padding: 0px;
		}

		.entry ul li:before {
  			display: none;
		}

		html>body .entry li {
			margin: 7px 0 7px 0;
		}

		.wrap-text {
			white-space: normal;
			word-wrap: break-word;
			max-width: 500px; /* Adjust the width as needed */
		}
	
		/* Container to align the maps side by side */
		.map-container .globe-container .bar-container {
			display: flex;
			width: 100%; 
			height: 100%; 
		}

		#bar {
			flex: 1;
			max-width: 25%;
			height: 100%;
			max-height: 100%;
		}

		#map {
			width: 100%;
			height: 100%;  /* or 100%, or whatever fits your layout */
			margin: 0;
			padding: 0;
		}

		#stack {
			flex: 3;
			max-width: 75%;
		}

		/* Style for the tabs */
		.tabs {
            display: flex;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .tab {
            padding: 5px 5px;
            margin-right: 10px;
            background-color: #143d59;
            border: 1px solid #ccc;
            border-radius: 5px;
			color: whitesmoke;
        }

        .tab:hover {
            background-color: #246a99;
        }

        .active-tab {
            background-color: #246a99;
            font-weight: bold;
        }

		/* Initially hide both containers */
		.globe-container, .map-container, .chart-container {
			display: none;
        }

        /* Show active container */
        .active-container {
            display: block;
        }

		/* Then override for bar-container */
		.chart-container.active-container {
			display: flex;
		}

		.map {
			flex: 1;
			height: 100%;
		}

		.globe {
			flex: 1;
			height: 100%;
		}

		.chart {
			width: 100%;
		}

		/* Container to align the tables side by side */
		.table-container {
			display: flex;
			justify-content: space-between;
			gap: 20px;
			position: relative;
		}

		/* Table styling */
		table {
			width: 100%;
			margin-top: 20px;
			border-collapse: collapse;
			padding: 10px;
			white-space: nowrap;
		}

		th, td {
			padding: 10px;
			text-align: left;
			border: 1px solid #ddd;
			white-space: nowrap;
		}

		th {
			background-color: #f4f4f4;
		}

		tfoot {
			font-weight: bold;
			background-color: #f9f9f9;
		}

		.faq-item {
			display: block;

			/*width: 38vw;
			min-width: 350px;*/
			margin-top: 0.5rem;
		}
		.item-question {
			background: #143d59;
			color: whitesmoke;
			font-size: 1rem;
			padding: 0.5rem;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.question-text {
			display: inline-block;
		}
		.arrows-container {
			margin: 0.4rem;
		}
		.item-answer {
			display: none;
			color: rgb(0, 0, 0);
			padding: 2rem;
		}
		.close {
			display: none;
		}

		.show-answer .item-answer {
			display: block;
			background: #8dc4ee;
		}
		.show-answer .close {
			display: inline;
		}
		.show-answer .expand {
			display: none;
		}

		/* Style for the arrow button */
		.arrow-button {
			background: #143d59;
			border: none;
			margin: none;
			color: whitesmoke;	
			padding: 10px;		
			font-size: 1rem; /* Increase size for better visibility */
			position: absolute; /* Position relative to the table container */
			top: 96.25px; /* Align with the top of the table */
			left: -42px; /* Place the button outside the table on the right */
			width: 42px;
			height: 42px;
			z-index: 10; /* Ensure the button is above other elements */
		}

		.arrow-button:focus {
			outline: none;
		}

		.noUi-horizontal {
			height: 5px;
		}

		.noUi-target {
			border: none;
			background: #e9e9e9;
		}

		.noUi-value {
			margin-top: 8px;
		}

		.noUi-tooltip {
			padding: 0px;
			border: 0px;
		}

		.noUi-connect {
			background: #588db1;;
		}

		.noUi-handle {
			background: #143d59;
			box-shadow: none;
			border: 0px;
			border-radius: 50%; 
		}

		.noUi-handle:before,
		.noUi-handle:after {
			display: none;
		}

		.noUi-pips-horizontal {
			padding: 3px;
		}

		.noUi-horizontal .noUi-handle{
			width: 20px;
			height: 20px;
			color: #000000;
			right: -10px;
			top: -7px;
		}

		.noUi-pips-horizontal{
			height: 10px;
		}

	</style>

	<div class="entry">
		<!-- Preamble to setup the content -->
		Welcome to our tracker of pollutant and greenhouse gas emissions from rocket launches. Select a time window of interest to visualise pollution on a globe, static map, or bar chart. For more information, see the <a href="#faqs-container">FAQs</a>  at the bottom of this page.
		<br>
		<br>
		The time window is for 5 years (2020-2024). <strong>We need your support to add more years and track emissions immediately after launches. Please donate to or share our <a href="https://gofund.me/3ba7e928" target="_blank">GoFundMe</a> page!</strong><br/>
		<br>
		<div class="filter-container">
			<div id="slider" style="width: 400px; margin-right:20px;"></div>
			<div class="filter">
				<label>Launch Site</label>
				<div class="dropdown" id="locationFilter">
					<ul></ul>
				</div>
			</div>
		
			<div class="filter">
				<label>Launch Vehicle</label>
				<div class="dropdown" id="rocketFilter">
					<ul></ul>
				</div>
			</div>
		
			<div class="filter">
				<label>Megaconstellation</label>
				<div class="dropdown" id="smcFilter">
					<ul></ul>
				</div>
			</div>
			
		</div>
		<br>

		<!-- Tabs for globe and map -->
		<div class="tabs">
			<div class="tab" id="chart-tab" onClick="toggleContainer('chart')">Chart</div>
			<div class="tab" id="globe-tab" onClick="toggleContainer('globe')">Globe</div>
			<div class="tab" id="map-tab"   onClick="toggleContainer('map')">Map</div>
			<button class="tab" type="submit" id="applyFilters">Apply Filters</button>
		</div>

		<div id="globe-container" class="globe-container"> <!-- Globe container -->
			<div id="globe" class="globe"></div> 
		</div>

		<div id="map-container" class="map-container"> <!-- Map container -->
			<div id="map" class="map"></div> 
		</div>
		
		<div id="chart-container" class="chart-container"> <!-- Chart container -->
			<div id="stack" class="chart"></div> <!-- Stack container -->
			<div id="bar"   class="chart"></div> <!-- Bar container -->
		</div>

		<!-- Table for Launch Locations -->
		<div class="table-container">
			<div>
				<h3>Launch Details (Click arrow to expand)</h3>
				<p>[Emissions in tonnes, time in UTC. SMC=Satellite Megaconstellation]</p>
				<table id="launchTable">
					<thead>
						<tr>
							<th>Date</th>
							<th>ID</th>
							<th>Time</th>
							<th>Launch Site</th>
							<th>Rocket</th>
							<th>SMC</th>
							<th>BC</th>
							<th>CO</th>
							<th>CO<sub>2</sub></th>
							<th>H<sub>2</sub>O</th>
							<th>Al<sub>2</sub>O<sub>3</sub></th>
							<th>Cl<sub>y</sub></th>
							<th>NO<sub>x</sub></th>
						</tr>
					</thead>
					<tbody id="launchTableBody" style="display: none;">
						<!-- Dynamic rows for launch locations will be inserted here -->
					</tbody>
					<tfoot id="launchTableFoot">
						<!-- Totals for launches -->
					</tfoot>
					<button id="toggleTableButton" class="arrow-button">&#9650;</button>
				</table>
			</div>
		</div>

		<script>

			const startYear = 2020;
			const endYear = 2024;
			const totalMonths = (endYear - startYear + 1) * 12;
			let globe;
			var slider = document.getElementById('slider');

			function indexToDate(index) {
				const year = startYear + Math.floor(index / 12);
				const intIndex = Math.floor(Number(index)); 
				const month = intIndex % 12;
				return `01/${String(month + 1).padStart(2, '0')}/${year}`;}

			function intToDateString(monthIndex) {

				// Calculate year and month offset
				const year = 2020 + Math.floor(monthIndex / 12);
				const month = (monthIndex % 12);

				// Build date object (day 1 of the month)
				const date = new Date(year, month, 1);

				// Format YYYY-MM-DD
				const yyyy = date.getFullYear();
				const mm = String(date.getMonth() + 1).padStart(2, '0'); // month is 0-based
				const dd = String(date.getDate()).padStart(2, '0');

				return `${yyyy}-${mm}-${dd}`;
				}

			noUiSlider.create(slider, {
				start: [0, 60],
				connect: true,
				step: 1,
				range: {
					min: 0,
					max: totalMonths,
				},
				tooltips: [        
					{
						to: value => indexToDate(value),
						from: () => 0
					},
					{
						to: value => indexToDate(value),
						from: () => 0
					}
				],
				format: {
					to: value => Math.round(value),
					from: value => Number(value)
				},
				pips: {
					mode: 'steps',
					density: 12,
					filter: function(value) {
						// Show label only every 12 months (1 year)
						return (value % 12 === 0) ? 1 : 0;  // 1 = show label, 0 = hide
					},
					format: {
						to: function(value) {
							// label only for year start (Jan)
							return value % 12 === 0 ? (startYear + value / 12) : '';
						}
					}
				}
			});	
			
			slider.noUiSlider.on('end', (values, handle) => {
				// values is an array of current slider values as strings
				// handle is 0 (left handle) or 1 (right handle)

				startDate = intToDateString(Number(values[0]));
				endDate = intToDateString(Number(values[1]));
				console.log(startDate, endDate);
				fetchEventsData(); // Fetch data 

				// Now update your data or UI based on leftValue and rightValue
				//updateMyData(leftValue, rightValue);
			});

			function populateFilters(launches) {
				// Get unique values from filtered_launches for each filter
				const locations = [...new Set(launches.text)];
				const rockets = [...new Set(launches.rocket)];
				const smcValues = [...new Set(launches.smc)];

				// Function to populate checkboxes inside a given filter dropdown
				function populateCheckboxes(filterId, values) {
					const dropdown = document.getElementById(filterId);
					const ul = dropdown.querySelector('ul');
					ul.innerHTML = ''; // Clear any previous entries

					values.forEach(value => {
						const li = document.createElement('li');
						li.innerHTML = `<label><input type="checkbox" value="${value}" /> ${value}</label>`;
						ul.appendChild(li);
					});
				}

				// Populate each filter
				populateCheckboxes('locationFilter', locations.sort());
				populateCheckboxes('rocketFilter', rockets.sort());
				populateCheckboxes('smcFilter', smcValues);
			}

			function filterlaunches(all_launches) {

				function getSelectedfilters(filter) {
					const var_filter = document.getElementById(filter);
					const checkboxes = var_filter.querySelectorAll('input[type="checkbox"]:checked');
					return Array.from(checkboxes).map(checkbox => checkbox.value);
				}

				// Get selected values from each filter
				const selectedLocations = getSelectedfilters('locationFilter');
				const selectedRockets   = getSelectedfilters('rocketFilter');
				const selectedSmc       = getSelectedfilters('smcFilter');

				// Find indices to keep based on selected filters
				let indicesToKeep = [...Array(all_launches.date.length).keys()];  // All indices initially

				// Filter based on location
				if (selectedLocations.length > 0) {
					indicesToKeep = indicesToKeep.filter(i => selectedLocations.includes(all_launches.text[i]));
				}

				// Filter based on rocket
				if (selectedRockets.length > 0) {
					indicesToKeep = indicesToKeep.filter(i => selectedRockets.includes(all_launches.rocket[i]));
				}

				// Filter based on smc
				if (selectedSmc.length > 0) {
					indicesToKeep = indicesToKeep.filter(i => selectedSmc.includes(all_launches.smc[i]));	
				}

				// Filter the column arrays using the indicesToKeep
				const filteredData = {
					date: indicesToKeep.map(i => all_launches.date[i]),
					time: indicesToKeep.map(i => all_launches.time[i]),
					lat: indicesToKeep.map(i => all_launches.lat[i]),
					lon: indicesToKeep.map(i => all_launches.lon[i]),
					text: indicesToKeep.map(i => all_launches.text[i]),
					id: indicesToKeep.map(i => all_launches.id[i]),
					rocket: indicesToKeep.map(i => all_launches.rocket[i]),
					smc: indicesToKeep.map(i => all_launches.smc[i] ? "Yes" : "No"),
					BC: indicesToKeep.map(i => all_launches.BC[i]),
					CO: indicesToKeep.map(i => all_launches.CO[i]),
					CO2: indicesToKeep.map(i => all_launches.CO2[i]),
					H2O: indicesToKeep.map(i => all_launches.H2O[i]),
					Al2O3: indicesToKeep.map(i => all_launches.Al2O3[i]),
					Cly: indicesToKeep.map(i => all_launches.Cly[i]),
					NOx: indicesToKeep.map(i => all_launches.NOx[i]),
				};

				// Update the visualizations with the filtered data
				updateVisualizations(filteredData);
			}

			function toggleContainer(containerType) {
				// Reset classes for all tabs and containers
				document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active-tab'));
				document.querySelectorAll('.globe-container, .map-container, .chart-container').forEach(container => container.classList.remove('active-container'));

				// Add active class to the clicked tab
				if (containerType === 'globe') {
					document.getElementById('globe-tab').classList.add('active-tab');
					document.getElementById('globe-container').classList.add('active-container');
					resizeGlobe();
				} else if (containerType === 'map') {
					document.getElementById('map-tab').classList.add('active-tab');
					document.getElementById('map-container').classList.add('active-container');
					Plotly.Plots.resize(document.getElementById('map'));
				} else if (containerType === 'chart') {
					document.getElementById('chart-tab').classList.add('active-tab');
					document.getElementById('chart-container').classList.add('active-container');
				}
			}	
			
			async function fetchEventsData() {
				try {
					// Fetch the data from the API (replace with your actual API URL)
					const response1 = await fetch(`https://cbarker.pythonanywhere.com/api/launches?start_date=${startDate}&end_date=${endDate}`); // Replace with your actual API URL
					const launchData = await response1.json();
					
					all_launches = {
						date: [],
						time: [],
						lat: [],
						lon: [],
						text: [],
						id: [],
						rocket: [],
						smc: [],
						BC: [],
						CO: [],
						CO2: [],
						H2O: [],
						Al2O3: [],
						Cly: [],
						NOx: []
					};

					Object.keys(launchData).forEach(date => {
						launchData[date].launches.forEach(launch => {
							all_launches.date.push(launch.date);
							all_launches.time.push(launch.time)
							all_launches.lat.push(parseFloat(launch.lat));
							all_launches.lon.push(parseFloat(launch.lon));
							all_launches.text.push(launch.location);
							all_launches.id.push(launch.id);
							all_launches.rocket.push(launch.rocket);
							all_launches.smc.push(launch.smc.toString());
							all_launches.BC.push(launch.emissions.BC);
							all_launches.CO.push(launch.emissions.CO);
							all_launches.CO2.push(launch.emissions.CO2);
							all_launches.H2O.push(launch.emissions.H2O);
							all_launches.Al2O3.push(launch.emissions.Al2O3);
							all_launches.Cly.push(launch.emissions.Cly);
							all_launches.NOx.push(launch.emissions.NOx);
						});
					});
					
					populateFilters(all_launches);
					updateVisualizations(all_launches);

				} catch (error) {
					console.error('Error fetching or processing the events data:', error);
				}
			}

			function updateVisualizations(filtered_launches) {
				updateTables(filtered_launches);
				updateMaps(filtered_launches);
				updateGraph(filtered_launches);
				updateGlobe(filtered_launches);
				updateStack(filtered_launches);
			}

			function updateGlobe(filtered_launches) {

				const gData = filtered_launches.lat.map((latitude, index) => {
					const longitude = filtered_launches.lon[index];

					return {
						lat: latitude,
						lon: longitude,
						//name: `Launch ID ${filtered_launches.id[index]}`,
					};
				});

				// Step 1: Group launches by site (lat/lng + site name as key)
				const siteMap = {};
				filtered_launches.lat.forEach((lat, i) => {
					const lng = filtered_launches.lon[i];
					const site = filtered_launches.text[i];  // launch site name
					const id = filtered_launches.id[i];
					const vehicle = filtered_launches.rocket[i];
					const key = `${site}_${lat}_${lng}`;

					if (!siteMap[key]) {
						siteMap[key] = {
						lat: lat - 1,
						lng,
						name: site,
						labels: []
						};
					}

					siteMap[key].labels.push(`Launch ${id} - ${vehicle}`);
				});

				// Step 2: Convert to array
				const labelSites = Object.values(siteMap);

				const OPACITYPATH  = 0.3;

				if (!globe) {
					globe = new Globe(document.getElementById('globe'))
						.globeImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-blue-marble.jpg')
						.pointLat(d => d.lat)
						.pointLng(d => d.lon)
						.pointColor(() => `rgba(0, 255, 0, ${OPACITYPATH})`)
						.pointRadius(0.5)
						.pointAltitude(0.2)
						.labelLat(d => d.lat)
						.labelLng(d => d.lng)
						.labelText(d => d.name)  // Label the location with the launch site.
						.labelLabel(d => d.labels.join('<br>'))  // Hover over label gives launch IDs.
						.labelResolution(2)
						.labelSize(1.5)
						.labelDotRadius(0);

					globe.pointsData(gData);
					globe.labelsData(labelSites);

					setTimeout(() => {
					globe
						.pointOfView({ lat: 0, lng: 0, altitude: 1.9 }, 1000);
					}, 0);
			
				} else {
					globe.pointsData(gData);
					globe.labelsData(labelSites);
				}
			}

			function updateTables(filtered_launches) {
				
				const table1Body = document.getElementById('launchTableBody');
				const table1Foot = document.getElementById('launchTableFoot');
				table1Body.innerHTML = '';
				table1Foot.innerHTML = '';
				let totalBC = 0, totalCO = 0, totalCO2 = 0, totalH2O = 0;
				let totalAl2O3 = 0, totalCly = 0, totalNOx = 0;
				filtered_launches.id.forEach((location, index) => {
					const row = document.createElement('tr');
					const BC = filtered_launches.BC[index];
					const CO = filtered_launches.CO[index];
					const CO2 = filtered_launches.CO2[index];
					const H2O = filtered_launches.H2O[index];
					const Al2O3 = filtered_launches.Al2O3[index];
					const Cly = filtered_launches.Cly[index];
					const NOx = filtered_launches.NOx[index];
					totalBC    += BC;
					totalCO    += CO;
					totalCO2   += CO2;
					totalH2O   += H2O;
					totalAl2O3 += Al2O3;
					totalCly   += Cly;
					totalNOx   += NOx;
					row.innerHTML = `
						<td>${filtered_launches.date[index]}</td> 
						<td>${location}</td>  
						<td>${filtered_launches.time[index].toFixed(2)}</td> 
						<td class="wrap-text">${filtered_launches.text[index]}</td> 
						<td class="wrap-text">${filtered_launches.rocket[index]}</td> 
						<td>${filtered_launches.smc[index]}</td> 
						<td>${filtered_launches.BC[index].toFixed(1)}</td> 
						<td>${filtered_launches.CO[index].toFixed(1)}</td> 
						<td>${filtered_launches.CO2[index].toFixed(1)}</td> 
						<td>${filtered_launches.H2O[index].toFixed(1)}</td> 
						<td>${filtered_launches.Al2O3[index].toFixed(1)}</td> 
						<td>${filtered_launches.Cly[index].toFixed(1)}</td> 
						<td>${filtered_launches.NOx[index].toFixed(1)}</td> 
					`;
					table1Body.appendChild(row);
				});
				// Add Totals to Launch Table
				const totalRow1 = document.createElement('tr');
				totalRow1.innerHTML = `
					<td>Total</td>
					<td>-</td>
					<td>-</td>
					<td>-</td>
					<td>-</td>
					<td>-</td>
					<td>${totalBC.toFixed(1)}</td>
					<td>${totalCO.toFixed(1)}</td>
					<td>${totalCO2.toFixed(1)}</td>
					<td>${totalH2O.toFixed(1)}</td>
					<td>${totalAl2O3.toFixed(1)}</td>
					<td>${totalCly.toFixed(1)}</td>
					<td>${totalNOx.toFixed(1)}</td>
				`;
				table1Foot.appendChild(totalRow1);
			}

			function updateMaps(filtered_launches) {
				const latitudes1 = filtered_launches.lat;
				const longitudes1 = filtered_launches.lon;
				const labels1 = filtered_launches.id;

				const mapData1 = latitudes1.length > 0 && longitudes1.length > 0 ? [{
					type: 'scattergeo',
					lat: latitudes1,
					lon: longitudes1,
					text: labels1,
					mode: 'markers+text',
					marker: {
					size: 12,
					color: 'blue',
					symbol: 'x',
					},
					textfont: {
						size: 15,  // Font size for the labels
						color: 'black',  // Color of the text
						weight: 'bold',
					},
					textposition: 'right',
				}] : [{
					type: 'scattergeo',
					mode: 'markers', // Keep the map but without data points
					marker: { size: 0 }, // Invisible markers
				}];

				const layout = {
					geo: {
						resolution: 100, 
						projection: { type: 'robinson' },
						showland: true,
						landcolor: 'rgb(217, 217, 217)',
						showocean: true,
						oceancolor: 'rgb(204, 233, 255)',
						showcountries: true,
						countrycolor: 'rgb(50, 50, 50)',
						showsubunits: true,
						subunitcolor: 'rgb(150, 150, 150)',
						showgrid: true,
						gridcolor: 'rgb(220, 220, 220)',
						gridwidth: 2,
						griddash: 'dash', // Dashed gridlines for both axes
						lataxis: {
							showgrid: true,  // Gridline for latitude axis
							gridcolor: 'rgb(220, 220, 220)', // Optional: specify grid color
							griddash: 'dash', // Dashed gridline style
							tickmode: 'array',
							ticks: '',
							ticklen: 10,
							tickcolor: 'rgb(220, 220, 220)',
							showticklabels: false,
							zeroline: false
						},
						lonaxis: {
							showgrid: true,  // Gridline for longitude axis
							gridcolor: 'rgb(220, 220, 220)', // Optional: specify grid color
							griddash: 'dash', // Dashed gridline style
							tickmode: 'array',
							ticks: '',
							ticklen: 10,
							tickcolor: 'rgb(220, 220, 220)',
							showticklabels: false,
							zeroline: false
						}
					},
					autosize: true,  // Automatically resize the chart
					margin: {
						l: 40,
						r: 40,
						t: 40,
						b: 40  // <- reduce bottom margin here
					}
				};

				// Render the maps with their legends
				Plotly.newPlot('map', mapData1, layout, {responsive: true});
			}

			const prettyNames = {
					BC: 'BC',
					CO: 'CO',
					CO2: 'CO<sub>2</sub>',
					H2O: 'H<sub>2</sub>O',
					Al2O3: 'Al<sub>2</sub>O<sub>3</sub>',
					Cly: 'Cl<sub>y</sub>',
					NOx: 'NO<sub>x</sub>'
					};
			
			function updateGraph(filtered_launches) {

				const totals = {
					BC: 0,
					CO: 0,
					CO2: 0,
					H2O: 0,
					Al2O3: 0,
					Cly: 0,
					NOx: 0
				};
				filtered_launches.id.forEach((location, index) => {
					totals.BC    += filtered_launches.BC[index];
					totals.CO    += filtered_launches.CO[index];
					totals.CO2   += filtered_launches.CO2[index];
					totals.H2O   += filtered_launches.H2O[index];
					totals.Al2O3 += filtered_launches.Al2O3[index];
					totals.Cly   += filtered_launches.Cly[index];
					totals.NOx   += filtered_launches.NOx[index];
				});
				
				// Prepare the data for Plotly
				const maxYValue = Object.values(totals).reduce((sum, val) => sum + val, 0);
				
				const trace = Object.keys(totals).map(key => ({
					x: ['Total'],
					y: [totals[key]],
					name: prettyNames[key],
					type: 'bar',
				}));
				
				const layout = {
					title: {
						text: 'Total Emissions',
					},
					barmode: 'stack',
					yaxis: {
						range: [0,maxYValue]
					},
					legend: {
						orientation: 'v',
						x: 1.05,
						y: 1,
						itemwidth: 3,
					},
					autosize: true,  // Automatically resize the chart
					margin: {
						l: 40,
						r: 40,
						t: 40,
						b: 0  // <- reduce bottom margin here
					}
				};

				// Plot the chart inside the 'emissionsChart' div
				Plotly.newPlot('bar', trace, layout, {responsive: true});

			}

			function updateStack(filtered_launches) {

				const species = ['BC', 'CO', 'CO2', 'H2O', 'Al2O3', 'Cly', 'NOx'];
				
				const monthlySums = {};

				// Step 1: Loop through each launch (index)
				for (let i = 0; i < filtered_launches.date.length; i++) {
					const month = filtered_launches.date[i].slice(0, 7);  // 'YYYY-MM'
					if (!monthlySums[month]) {
						monthlySums[month] = {};
						species.forEach(sp => monthlySums[month][sp] = 0);
					}
					species.forEach(sp => {
						monthlySums[month][sp] += Number(filtered_launches[sp][i]) || 0; // Ensure numeric
					});
					}

				const months = Object.keys(monthlySums).sort();
				const maxYValue = Math.max(...months);

				const traces = species.map(sp => ({
					x: months,
					y: months.map(m => monthlySums[m][sp]),
					stackgroup: 'one',
					name: prettyNames[sp],
					type: 'scatter',
					mode: 'none',
				}));

				const layout = {
					autosize: true,
					title: {
						text: 'Monthly Emissions (click legend to show/hide species)',
					},
					font: {
						size: 12        // x-axis font size
					},
					yaxis: {
						title: {
							text: 'Mass [t]',
						},
						range: [0,maxYValue]
					},
					legend: {
						orientation: 'v',
						x: 1.05,
						y: 1
					},
					autosize: true,  // Automatically resize the chart
					margin: {
						l: 40,
						r: 40,
						t: 40,
						b: 0  // <- reduce bottom margin here
					}
				};

				Plotly.newPlot('stack', traces , layout, {responsive: true});

				}
			
			// Plot a default date when the page opens, then update when the date changes.
			document.addEventListener('DOMContentLoaded', () => {

				const daterange = slider.noUiSlider.get();
				startDate = intToDateString(Number(daterange[0]));
				endDate = intToDateString(Number(daterange[1]));
				fetchEventsData(); // Fetch data for the default date

				document.getElementById('applyFilters').addEventListener('click', () => {
					filterlaunches(all_launches);
				});
			});
	
			// JavaScript to toggle the table visibility and update the arrow
			const toggleButton = document.getElementById('toggleTableButton');
			const tableBody = document.getElementById('launchTableBody');

			// Initialize with the globe container active
			toggleContainer('chart');

			toggleButton.addEventListener('click', () => {
				const isHidden = tableBody.style.display === 'none';
				tableBody.style.display = isHidden ? 'table-row-group' : 'none';
				toggleButton.innerHTML = isHidden ? '&#9660;' : '&#9650;'; // Down arrow when shown, up arrow when hidden
			});

			document.querySelectorAll('.filter').forEach(filter => {
				filter.addEventListener('click', e => {
					// Prevent toggling when clicking inside dropdown list itself
					if (e.target.closest('.dropdown ul')) return;

					// Close other open dropdowns first (optional)
					document.querySelectorAll('.filter.open').forEach(openFilter => {
					if (openFilter !== filter) openFilter.classList.remove('open');
					});

					// Toggle current filter open class
					filter.classList.toggle('open');
				});
			});

			// Optional: Close dropdowns if clicked outside
			document.addEventListener('click', e => {
				if (!e.target.closest('.filter')) {
					document.querySelectorAll('.filter.open').forEach(openFilter => {
					openFilter.classList.remove('open');
					});
				}
			});

			// Function to resize the globe based on its container size
			const resizeGlobe = () => {
				const container = document.getElementById('globe');
				// Set the width and height of the globe based on the container's size
				globe.width(container.offsetWidth).height(container.offsetHeight);
				
				// Manually reset the canvas element size to match the container size
				const canvas = document.querySelector('canvas');
				canvas.style.width = `${container.offsetWidth}px`;
				canvas.style.height = `${container.offsetHeight}px`;
				canvas.style.transform = 'none';
			};

		</script> 
		<br>
		<a href="#">Go to Top</a>
		<br>
		<br>
		<h2>Frequently Asked Questions</h2>

		<div id="faqs-container"></div>

		<script>
			const faqData = [ 
				{ question: "What are these chemicals? ",
				answer: "NO<sub>x</sub> is nitrogen oxides, H<sub>2</sub>O is water vapour, CO<sub>2</sub> is carbon dioxide, BC is black carbon or soot, Al<sub>2</sub>O<sub>3</sub> is aluminium oxide or alumina, and Cl<sub>y</sub> is a family of chlorine compounds. NO<sub>x</sub>, H<sub>2</sub>O, CO<sub>2</sub>, and Cl<sub>y</sub> are released as gases, BC and Al<sub>2</sub>O<sub>3</sub> as particles."
				},
				{ question: "How do these chemicals affect the atmosphere?",
				answer: "Unlike man-made emissions from the surface of the Earth, rocket launches release air pollutant and CO<sub>2</sub> emissions throughout the atmosphere, where they can have an outsized impact on our atmosphere and climate. NO<sub>x</sub> and Cl<sub>y</sub> are the largest contributors to destruction of the ozone layer from rocket emissions, with smaller destruction occuring from emissions of BC and Al<sub>2</sub>O<sub>3</sub> particles. The largest climate impacts come from BC emissions, which warm the upper layers of the atmosphere while cooling the lower layers."
				},
				{ question: "What does each filter represent?",
				answer: "Launch site refers to the location of the rocket launch. Launch vehicle refers to the type of rocket used for the launch. Megaconstellation refers to whether the launch contains megaconstellation payloads."
				},
				{ question: "How is this data calculated?",
				answer: "Our calculations are based on the current best scientific knowledge available for emissions from rocket launches. We include the effects of a changing chemical environment with altitude in our launch emissions, and calculate emissions globally up to a maximum altitude of 80 km. Paths shown in the Globe view are fixed at the launch site and do not represent real rocket trajectories."
				},
				{ question: "Where can I find the original methodology and data?",
				answer: "You can find further details in our study published in Nature Scientific Data: Global 3D rocket launch and re-entry air pollutant and carbon dioxide emissions for 2020-2022</strong>. C. R. Barker, E. A. Marais (2024). doi:10.5522/04/26325382. [<a href='https://doi.org/10.5522/04/26325382' target='_blank' rel='noopener noreferrer'>Data</a>]. [<a href='https://www.nature.com/articles/s41597-024-03910-z' target='_blank' rel='noopener noreferrer'>Publication</a>]</p>"
				}
			];

			const faqsContainer = document.getElementById('faqs-container');

			faqData.map(function(item) {

				let article = document.createElement('article');
				article.classList.add('faq-item');

				const markup = `
						<div class="item-question">
							<span class="question-text">${item.question}</span>
							<span class="arrows-container">
								<span class="expand">▼</span>
								<span class="close">▲</span>
							</span>
						</div>
						<div class="item-answer">
							<span>${item.answer}</span>
						</div>
				`;
				
				article.innerHTML = markup;
				faqsContainer.append(article);
			});

			const toggleButtons = document.querySelectorAll('.arrows-container');
				
			toggleButtons.forEach(button => {
				button.addEventListener('click', function(e) {
					const faqItem = e.currentTarget.parentElement.parentElement;
					faqItem.classList.toggle("show-answer");
				});
			});

		</script>

		<p>
			Developed by <a href="https://profiles.ucl.ac.uk/93616-connor-barker" target="_blank" rel="noopener noreferrer">Connor Barker</a> (UCL postdoc) and <a href="https://profiles.ucl.ac.uk/77783-eloise-marais" target="_blank" rel="noopener noreferrer">Eloise Marais</a> (UCL PI), in collaboration with <a href="https://www.cfa.harvard.edu/people/jonathan-mcdowell" target="_blank" rel="noopener noreferrer">Jonathan McDowell</a> (Harvard-Smithsonian Center for Astrophysics) and Eric Tan (UCL Department of Astrophysics). Interested in using the data or spot any room for improvements? Please reach out to Connor Barker at <a href= "mailto:name@email.com">connor.barker@ucl.ac.uk</a>.
		</p>
		<p>
			<strong>Funding Disclaimer:</strong> This project has received funding from the European Research Council (ERC) under the European Union’s Horizon 2020 research and innovation programme (grant agreement No. 851854). <a href="https://cordis.europa.eu/project/id/851854" target="_blank" rel="noopener noreferrer">European Commission project page</a>.
		</p>
	</div>
	</div>
	</div>
</div>

<hr />
<div id="footer">
	<p>
		<br> <br />
	</p>
</div>
<script type="text/javascript' src='./js/wp-embed.min.js"></script>
</body>
</html>